From 038545c6e3d52fff9b75f1700b439f52fd91e18a Mon Sep 17 00:00:00 2001
From: yumingyang <yumingyang@xiaomi.com>
Date: Wed, 13 Mar 2013 19:29:37 +0800
Subject: [PATCH 04/10] add miui hook for v5 into services

Change-Id: I5e0d527e14aebf30c09c46bae81b25813b032ba8

Signed-off-by: santajin <zj1860263@163.com>
---
 .../smali/com/android/server/AttributeCache.smali  |    6 +-
 ...ackupManagerService$PerformFullBackupTask.smali |   18 +-
 ...ckupManagerService$PerformFullRestoreTask.smali |    2 +-
 .../android/server/InputMethodManagerService.smali |   35 ++++
 .../android/server/StatusBarManagerService.smali   |  186 ++++++++++++++++++++
 .../android/server/am/ActivityManagerService.smali |   32 +++-
 .../server/am/AppNotRespondingDialog$1.smali       |    3 +-
 .../android/server/am/AppNotRespondingDialog.smali |   12 ++
 .../com/android/server/am/BaseErrorDialog.smali    |    2 +-
 .../server/net/NetworkPolicyManagerService.smali   |   46 ++---
 .../smali/com/android/server/pm/Installer.smali    |   19 +-
 .../android/server/pm/PackageManagerService.smali  |  100 ++++++++++-
 .../com/android/server/pm/ShutdownThread.smali     |    4 +-
 .../smali/com/android/server/pm/UserManager.smali  |   12 +-
 .../android/server/wm/WindowManagerService.smali   |    4 +
 15 files changed, 417 insertions(+), 64 deletions(-)

diff --git a/services.jar.out/smali/com/android/server/AttributeCache.smali b/services.jar.out/smali/com/android/server/AttributeCache.smali
index 5f7ce19..f2a6973 100644
--- a/services.jar.out/smali/com/android/server/AttributeCache.smali
+++ b/services.jar.out/smali/com/android/server/AttributeCache.smali
@@ -114,12 +114,10 @@
     :try_start_0
     iget-object v7, p0, Lcom/android/server/AttributeCache;->mPackages:Ljava/util/WeakHashMap;
 
-    invoke-virtual {v7, p1}, Ljava/util/WeakHashMap;->get(Ljava/lang/Object;)Ljava/lang/Object;
+    invoke-static {v7, p1}, Lcom/android/server/AttributeCache$Injector;->getPackage(Ljava/util/WeakHashMap;Ljava/lang/String;)Lcom/android/server/AttributeCache$Package;
 
     move-result-object v5
 
-    check-cast v5, Lcom/android/server/AttributeCache$Package;
-
     .local v5, pkg:Lcom/android/server/AttributeCache$Package;
     const/4 v4, 0x0
 
@@ -220,7 +218,7 @@
     .restart local v5       #pkg:Lcom/android/server/AttributeCache$Package;
     iget-object v7, p0, Lcom/android/server/AttributeCache;->mPackages:Ljava/util/WeakHashMap;
 
-    invoke-virtual {v7, p1, v5}, Ljava/util/WeakHashMap;->put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
+    invoke-static {v7, p1, v5}, Lcom/android/server/AttributeCache$Injector;->putPackage(Ljava/util/WeakHashMap;Ljava/lang/String;Lcom/android/server/AttributeCache$Package;)V
 
     .end local v0           #context:Landroid/content/Context;
     :cond_2
diff --git a/services.jar.out/smali/com/android/server/BackupManagerService$PerformFullBackupTask.smali b/services.jar.out/smali/com/android/server/BackupManagerService$PerformFullBackupTask.smali
index 9d1e899..80633ae 100644
--- a/services.jar.out/smali/com/android/server/BackupManagerService$PerformFullBackupTask.smali
+++ b/services.jar.out/smali/com/android/server/BackupManagerService$PerformFullBackupTask.smali
@@ -1745,23 +1745,9 @@
     check-cast v19, Landroid/content/pm/PackageInfo;
 
     .restart local v19       #pkg:Landroid/content/pm/PackageInfo;
-    move-object/from16 v0, v19
-
-    iget-object v0, v0, Landroid/content/pm/PackageInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    move-object/from16 v21, v0
-
-    move-object/from16 v0, v21
-
-    iget v0, v0, Landroid/content/pm/ApplicationInfo;->flags:I
-
-    move/from16 v21, v0
-
-    const v22, 0x8000
-
-    and-int v21, v21, v22
+    sget-boolean v21, Lcom/android/server/BackupManagerService$Injector;->FALSE:Z
 
-    if-eqz v21, :cond_3
+    if-nez v21, :cond_3
 
     move-object/from16 v0, v19
 
diff --git a/services.jar.out/smali/com/android/server/BackupManagerService$PerformFullRestoreTask.smali b/services.jar.out/smali/com/android/server/BackupManagerService$PerformFullRestoreTask.smali
index bbb788c..a88913a 100644
--- a/services.jar.out/smali/com/android/server/BackupManagerService$PerformFullRestoreTask.smali
+++ b/services.jar.out/smali/com/android/server/BackupManagerService$PerformFullRestoreTask.smali
@@ -1460,7 +1460,7 @@
     move-result v7
 
     .local v7, didRead:I
-    if-ltz v7, :cond_0
+    if-ltz v7, :cond_2
 
     move-object/from16 v0, p0
 
diff --git a/services.jar.out/smali/com/android/server/InputMethodManagerService.smali b/services.jar.out/smali/com/android/server/InputMethodManagerService.smali
index f00285a..2561c89 100644
--- a/services.jar.out/smali/com/android/server/InputMethodManagerService.smali
+++ b/services.jar.out/smali/com/android/server/InputMethodManagerService.smali
@@ -3797,6 +3797,8 @@
 
     invoke-virtual {v11, v0}, Landroid/widget/Switch;->setOnCheckedChangeListener(Landroid/widget/CompoundButton$OnCheckedChangeListener;)V
 
+    invoke-virtual/range {p0 .. p0}, Lcom/android/server/InputMethodManagerService;->removeCustomTitle()V
+
     new-instance v6, Lcom/android/server/InputMethodManagerService$ImeSubtypeListAdapter;
 
     const v23, 0x10900ab
@@ -7424,6 +7426,39 @@
     throw v0
 .end method
 
+.method removeCustomTitle()V
+    .locals 3
+    .annotation build Landroid/annotation/MiuiHook;
+        value = .enum Landroid/annotation/MiuiHook$MiuiHookType;->NEW_METHOD:Landroid/annotation/MiuiHook$MiuiHookType;
+    .end annotation
+
+    .prologue
+    const/4 v2, 0x0
+
+    iget-object v0, p0, Lcom/android/server/InputMethodManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v0}, Lmiui/util/UiUtils;->isV5Ui(Landroid/content/Context;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/server/InputMethodManagerService;->mDialogBuilder:Landroid/app/AlertDialog$Builder;
+
+    invoke-virtual {v0, v2}, Landroid/app/AlertDialog$Builder;->setCustomTitle(Landroid/view/View;)Landroid/app/AlertDialog$Builder;
+
+    iget-object v0, p0, Lcom/android/server/InputMethodManagerService;->mDialogBuilder:Landroid/app/AlertDialog$Builder;
+
+    const v1, 0x1040447
+
+    invoke-virtual {v0, v1}, Landroid/app/AlertDialog$Builder;->setTitle(I)Landroid/app/AlertDialog$Builder;
+
+    iput-object v2, p0, Lcom/android/server/InputMethodManagerService;->mSwitchingDialogTitleView:Landroid/view/View;
+
+    :cond_0
+    return-void
+.end method
+
 .method public setAdditionalInputMethodSubtypes(Ljava/lang/String;[Landroid/view/inputmethod/InputMethodSubtype;)V
     .locals 10
     .parameter "imiId"
diff --git a/services.jar.out/smali/com/android/server/StatusBarManagerService.smali b/services.jar.out/smali/com/android/server/StatusBarManagerService.smali
index 4812704..974fd3c 100644
--- a/services.jar.out/smali/com/android/server/StatusBarManagerService.smali
+++ b/services.jar.out/smali/com/android/server/StatusBarManagerService.smali
@@ -69,6 +69,21 @@
     .end annotation
 .end field
 
+.field mStatusRecords:Ljava/util/ArrayList;
+    .annotation build Landroid/annotation/MiuiHook;
+        value = .enum Landroid/annotation/MiuiHook$MiuiHookType;->NEW_FIELD:Landroid/annotation/MiuiHook$MiuiHookType;
+    .end annotation
+
+    .annotation system Ldalvik/annotation/Signature;
+        value = {
+            "Ljava/util/ArrayList",
+            "<",
+            "Lcom/android/server/StatusBarManagerService$StatusRecord;",
+            ">;"
+        }
+    .end annotation
+.end field
+
 .field mSysUiVisToken:Landroid/os/IBinder;
 
 .field mSystemUiVisibility:I
@@ -111,6 +126,12 @@
 
     iput-object v1, p0, Lcom/android/server/StatusBarManagerService;->mDisableRecords:Ljava/util/ArrayList;
 
+    new-instance v1, Ljava/util/ArrayList;
+
+    invoke-direct {v1}, Ljava/util/ArrayList;-><init>()V
+
+    iput-object v1, p0, Lcom/android/server/StatusBarManagerService;->mStatusRecords:Ljava/util/ArrayList;
+
     new-instance v1, Landroid/os/Binder;
 
     invoke-direct {v1}, Landroid/os/Binder;-><init>()V
@@ -929,6 +950,117 @@
     goto :goto_1
 .end method
 
+.method manageStatusListLocked(ILandroid/os/IBinder;Ljava/lang/String;)V
+    .locals 7
+    .parameter "what"
+    .parameter "token"
+    .parameter "pkg"
+    .annotation build Landroid/annotation/MiuiHook;
+        value = .enum Landroid/annotation/MiuiHook$MiuiHookType;->NEW_METHOD:Landroid/annotation/MiuiHook$MiuiHookType;
+    .end annotation
+
+    .prologue
+    const/4 v6, 0x0
+
+    iget-object v5, p0, Lcom/android/server/StatusBarManagerService;->mStatusRecords:Ljava/util/ArrayList;
+
+    invoke-virtual {v5}, Ljava/util/ArrayList;->size()I
+
+    move-result v0
+
+    .local v0, N:I
+    const/4 v4, 0x0
+
+    .local v4, tok:Lcom/android/server/StatusBarManagerService$StatusRecord;
+    const/4 v2, 0x0
+
+    .local v2, i:I
+    :goto_0
+    if-ge v2, v0, :cond_0
+
+    iget-object v5, p0, Lcom/android/server/StatusBarManagerService;->mStatusRecords:Ljava/util/ArrayList;
+
+    invoke-virtual {v5, v2}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
+
+    move-result-object v3
+
+    check-cast v3, Lcom/android/server/StatusBarManagerService$StatusRecord;
+
+    .local v3, t:Lcom/android/server/StatusBarManagerService$StatusRecord;
+    iget-object v5, v3, Lcom/android/server/StatusBarManagerService$StatusRecord;->token:Landroid/os/IBinder;
+
+    if-ne v5, p2, :cond_3
+
+    move-object v4, v3
+
+    .end local v3           #t:Lcom/android/server/StatusBarManagerService$StatusRecord;
+    :cond_0
+    if-eqz p1, :cond_1
+
+    invoke-interface {p2}, Landroid/os/IBinder;->isBinderAlive()Z
+
+    move-result v5
+
+    if-nez v5, :cond_4
+
+    :cond_1
+    if-eqz v4, :cond_2
+
+    iget-object v5, p0, Lcom/android/server/StatusBarManagerService;->mStatusRecords:Ljava/util/ArrayList;
+
+    invoke-virtual {v5, v2}, Ljava/util/ArrayList;->remove(I)Ljava/lang/Object;
+
+    iget-object v5, v4, Lcom/android/server/StatusBarManagerService$StatusRecord;->token:Landroid/os/IBinder;
+
+    invoke-interface {v5, v4, v6}, Landroid/os/IBinder;->unlinkToDeath(Landroid/os/IBinder$DeathRecipient;I)Z
+
+    :cond_2
+    :goto_1
+    return-void
+
+    .restart local v3       #t:Lcom/android/server/StatusBarManagerService$StatusRecord;
+    :cond_3
+    add-int/lit8 v2, v2, 0x1
+
+    goto :goto_0
+
+    .end local v3           #t:Lcom/android/server/StatusBarManagerService$StatusRecord;
+    :cond_4
+    if-nez v4, :cond_5
+
+    new-instance v4, Lcom/android/server/StatusBarManagerService$StatusRecord;
+
+    .end local v4           #tok:Lcom/android/server/StatusBarManagerService$StatusRecord;
+    const/4 v5, 0x0
+
+    invoke-direct {v4, p0, v5}, Lcom/android/server/StatusBarManagerService$StatusRecord;-><init>(Lcom/android/server/StatusBarManagerService;Lcom/android/server/StatusBarManagerService$1;)V
+
+    .restart local v4       #tok:Lcom/android/server/StatusBarManagerService$StatusRecord;
+    const/4 v5, 0x0
+
+    :try_start_0
+    invoke-interface {p2, v4, v5}, Landroid/os/IBinder;->linkToDeath(Landroid/os/IBinder$DeathRecipient;I)V
+    :try_end_0
+    .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
+
+    iget-object v5, p0, Lcom/android/server/StatusBarManagerService;->mStatusRecords:Ljava/util/ArrayList;
+
+    invoke-virtual {v5, v4}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
+
+    :cond_5
+    iput-object p2, v4, Lcom/android/server/StatusBarManagerService$StatusRecord;->token:Landroid/os/IBinder;
+
+    iput-object p3, v4, Lcom/android/server/StatusBarManagerService$StatusRecord;->pkg:Ljava/lang/String;
+
+    goto :goto_1
+
+    :catch_0
+    move-exception v1
+
+    .local v1, ex:Landroid/os/RemoteException;
+    goto :goto_1
+.end method
+
 .method public onClearAllNotifications()V
     .locals 1
 
@@ -1778,6 +1910,60 @@
     return-void
 .end method
 
+.method public setStatus(ILandroid/os/IBinder;Ljava/lang/String;Landroid/os/Bundle;)V
+    .locals 2
+    .parameter "what"
+    .parameter "token"
+    .parameter "action"
+    .parameter "ext"
+    .annotation build Landroid/annotation/MiuiHook;
+        value = .enum Landroid/annotation/MiuiHook$MiuiHookType;->NEW_METHOD:Landroid/annotation/MiuiHook$MiuiHookType;
+    .end annotation
+
+    .prologue
+    iget-object v1, p0, Lcom/android/server/StatusBarManagerService;->mLock:Ljava/lang/Object;
+
+    monitor-enter v1
+
+    :try_start_0
+    invoke-virtual {p0, p1, p2, p3}, Lcom/android/server/StatusBarManagerService;->manageStatusListLocked(ILandroid/os/IBinder;Ljava/lang/String;)V
+
+    iget-object v0, p0, Lcom/android/server/StatusBarManagerService;->mBar:Lcom/android/internal/statusbar/IStatusBar;
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    if-eqz v0, :cond_0
+
+    :try_start_1
+    iget-object v0, p0, Lcom/android/server/StatusBarManagerService;->mBar:Lcom/android/internal/statusbar/IStatusBar;
+
+    invoke-interface {v0, p1, p3, p4}, Lcom/android/internal/statusbar/IStatusBar;->setStatus(ILjava/lang/String;Landroid/os/Bundle;)V
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+    .catch Landroid/os/RemoteException; {:try_start_1 .. :try_end_1} :catch_0
+
+    :cond_0
+    :goto_0
+    :try_start_2
+    monitor-exit v1
+
+    return-void
+
+    :catchall_0
+    move-exception v0
+
+    monitor-exit v1
+    :try_end_2
+    .catchall {:try_start_2 .. :try_end_2} :catchall_0
+
+    throw v0
+
+    :catch_0
+    move-exception v0
+
+    goto :goto_0
+.end method
+
 .method public setSystemUiVisibility(II)V
     .locals 4
     .parameter "vis"
diff --git a/services.jar.out/smali/com/android/server/am/ActivityManagerService.smali b/services.jar.out/smali/com/android/server/am/ActivityManagerService.smali
index e872474..a726a13 100644
--- a/services.jar.out/smali/com/android/server/am/ActivityManagerService.smali
+++ b/services.jar.out/smali/com/android/server/am/ActivityManagerService.smali
@@ -1351,7 +1351,7 @@
     .local v1, systemDir:Ljava/io/File;
     invoke-virtual {v1}, Ljava/io/File;->mkdirs()Z
 
-    invoke-static {v1, v0}, Lmiui/os/Environment;->init(Ljava/io/File;Ljava/io/File;)V
+    invoke-static {}, Lcom/android/server/am/ExtraActivityManagerService;->init()V
 
     new-instance v2, Lcom/android/server/am/BatteryStatsService;
 
@@ -5846,17 +5846,21 @@
     move-result-object v8
 
     .restart local v8       #queue:Lcom/android/server/am/BroadcastQueue;
+    move-object/from16 v0, p0
+
+    iget-object v3, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->getRunningAppProcesses()Ljava/util/List;
 
-    move-result-object v3
+    move-result-object v5
 
     invoke-virtual/range {v44 .. v44}, Landroid/content/Intent;->getAction()Ljava/lang/String;
 
-    move-result-object v5
+    move-result-object v9
 
     move-object/from16 v0, v24
 
-    invoke-static {v0, v3, v5}, Lcom/android/server/am/ExtraActivityManagerService;->adjustMediaButtonReceivers(Ljava/util/List;Ljava/util/List;Ljava/lang/String;)V
+    invoke-static {v3, v0, v5, v9}, Lcom/android/server/am/ExtraActivityManagerService;->adjustMediaButtonReceivers(Landroid/content/Context;Ljava/util/List;Ljava/util/List;Ljava/lang/String;)V
 
     new-instance v7, Lcom/android/server/am/BroadcastRecord;
 
@@ -8436,11 +8440,17 @@
     const/16 v23, 0x0
 
     .local v23, interesting:Z
-    move-object/from16 v0, p1
+    move-object/from16 v0, p0
 
-    move-object/from16 v1, p3
+    move-object/from16 v1, p1
+
+    move-object/from16 v2, p3
+
+    invoke-static {v0, v1, v2}, Lcom/android/server/am/ActivityManagerService$Injector;->isForegroudApp(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/ProcessRecord;Lcom/android/server/am/ProcessRecord;)Z
+
+    move-result v2
 
-    if-ne v0, v1, :cond_16
+    if-eqz v2, :cond_16
 
     const/4 v11, 0x0
 
@@ -20031,7 +20041,7 @@
     move-result-object v1
 
     .local v1, context:Landroid/content/Context;
-    const v4, 0x103006e
+    const v4, 0x60d003a
 
     invoke-virtual {v1, v4}, Landroid/content/Context;->setTheme(I)V
 
@@ -43895,6 +43905,12 @@
 
     invoke-direct/range {v2 .. v16}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;Ljava/lang/String;ZZIII)I
 
+    move-object/from16 v0, p0
+
+    iget-object v2, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v2}, Lcom/android/server/am/ExtraActivityManagerService;->finishBooting(Landroid/content/Context;)V
+
     .end local v19           #nmsg:Landroid/os/Message;
     :cond_1
     monitor-exit p0
diff --git a/services.jar.out/smali/com/android/server/am/AppNotRespondingDialog$1.smali b/services.jar.out/smali/com/android/server/am/AppNotRespondingDialog$1.smali
index 5506afe..415e6f7 100644
--- a/services.jar.out/smali/com/android/server/am/AppNotRespondingDialog$1.smali
+++ b/services.jar.out/smali/com/android/server/am/AppNotRespondingDialog$1.smali
@@ -51,8 +51,7 @@
 
     iget-object v4, p0, Lcom/android/server/am/AppNotRespondingDialog$1;->this$0:Lcom/android/server/am/AppNotRespondingDialog;
 
-    #getter for: Lcom/android/server/am/AppNotRespondingDialog;->mProc:Lcom/android/server/am/ProcessRecord;
-    invoke-static {v4}, Lcom/android/server/am/AppNotRespondingDialog;->access$000(Lcom/android/server/am/AppNotRespondingDialog;)Lcom/android/server/am/ProcessRecord;
+    invoke-virtual {v4}, Lcom/android/server/am/AppNotRespondingDialog;->getProc()Lcom/android/server/am/ProcessRecord;
 
     move-result-object v4
 
diff --git a/services.jar.out/smali/com/android/server/am/AppNotRespondingDialog.smali b/services.jar.out/smali/com/android/server/am/AppNotRespondingDialog.smali
index 9911ec0..3b774fb 100644
--- a/services.jar.out/smali/com/android/server/am/AppNotRespondingDialog.smali
+++ b/services.jar.out/smali/com/android/server/am/AppNotRespondingDialog.smali
@@ -300,6 +300,18 @@
 
 
 # virtual methods
+.method getProc()Lcom/android/server/am/ProcessRecord;
+    .locals 1
+    .annotation build Landroid/annotation/MiuiHook;
+        value = .enum Landroid/annotation/MiuiHook$MiuiHookType;->NEW_METHOD:Landroid/annotation/MiuiHook$MiuiHookType;
+    .end annotation
+
+    .prologue
+    iget-object v0, p0, Lcom/android/server/am/AppNotRespondingDialog;->mProc:Lcom/android/server/am/ProcessRecord;
+
+    return-object v0
+.end method
+
 .method public onStop()V
     .locals 0
 
diff --git a/services.jar.out/smali/com/android/server/am/BaseErrorDialog.smali b/services.jar.out/smali/com/android/server/am/BaseErrorDialog.smali
index 94d91f0..3808ce7 100644
--- a/services.jar.out/smali/com/android/server/am/BaseErrorDialog.smali
+++ b/services.jar.out/smali/com/android/server/am/BaseErrorDialog.smali
@@ -20,7 +20,7 @@
     .prologue
     const/high16 v2, 0x2
 
-    const v0, 0x60d0020
+    const v0, 0x60d003e
 
     invoke-direct {p0, p1, v0}, Landroid/app/AlertDialog;-><init>(Landroid/content/Context;I)V
 
diff --git a/services.jar.out/smali/com/android/server/net/NetworkPolicyManagerService.smali b/services.jar.out/smali/com/android/server/net/NetworkPolicyManagerService.smali
index 8bd7b9f..53788f6 100644
--- a/services.jar.out/smali/com/android/server/net/NetworkPolicyManagerService.smali
+++ b/services.jar.out/smali/com/android/server/net/NetworkPolicyManagerService.smali
@@ -1343,10 +1343,6 @@
 
     .restart local v14       #title:Ljava/lang/CharSequence;
     :goto_2
-    const/4 v1, 0x1
-
-    invoke-virtual {v8, v1}, Landroid/app/Notification$Builder;->setOngoing(Z)Landroid/app/Notification$Builder;
-
     const v1, 0x1080510
 
     invoke-virtual {v8, v1}, Landroid/app/Notification$Builder;->setSmallIcon(I)Landroid/app/Notification$Builder;
@@ -1478,10 +1474,6 @@
 
     .restart local v14       #title:Ljava/lang/CharSequence;
     :goto_3
-    const/4 v1, 0x1
-
-    invoke-virtual {v8, v1}, Landroid/app/Notification$Builder;->setOngoing(Z)Landroid/app/Notification$Builder;
-
     const v1, 0x1080078
 
     invoke-virtual {v8, v1}, Landroid/app/Notification$Builder;->setSmallIcon(I)Landroid/app/Notification$Builder;
@@ -1705,7 +1697,7 @@
 .end method
 
 .method private enqueueValidNotification(Landroid/net/NetworkPolicy;IJ)V
-    .locals 1
+    .locals 2
     .parameter "policy"
     .parameter "type"
     .parameter "totalBytes"
@@ -1716,16 +1708,28 @@
     .prologue
     invoke-static {p2}, Lcom/android/server/net/NetworkPolicyManagerService$Injector;->isIntervalValid(I)Z
 
-    move-result v0
+    move-result v1
 
-    if-eqz v0, :cond_0
+    if-eqz v1, :cond_0
 
     invoke-static {p2}, Lcom/android/server/net/NetworkPolicyManagerService$Injector;->setInterval(I)V
 
     invoke-direct {p0, p1, p2, p3, p4}, Lcom/android/server/net/NetworkPolicyManagerService;->enqueueNotification(Landroid/net/NetworkPolicy;IJ)V
 
-    :cond_0
+    :goto_0
     return-void
+
+    :cond_0
+    invoke-direct {p0, p1, p2}, Lcom/android/server/net/NetworkPolicyManagerService;->buildNotificationTag(Landroid/net/NetworkPolicy;I)Ljava/lang/String;
+
+    move-result-object v0
+
+    .local v0, tag:Ljava/lang/String;
+    iget-object v1, p0, Lcom/android/server/net/NetworkPolicyManagerService;->mActiveNotifs:Ljava/util/HashSet;
+
+    invoke-virtual {v1, v0}, Ljava/util/HashSet;->add(Ljava/lang/Object;)Z
+
+    goto :goto_0
 .end method
 
 .method private ensureActiveMobilePolicyLocked()V
@@ -2117,26 +2121,22 @@
     const-wide/16 v7, 0x0
 
     :try_start_0
-    iget-object v0, p0, Lcom/android/server/net/NetworkPolicyManagerService;->mNetworkStats:Landroid/net/INetworkStatsService;
+    iget-object v1, p0, Lcom/android/server/net/NetworkPolicyManagerService;->mNetworkStats:Landroid/net/INetworkStatsService;
 
-    move-object v1, p1
-
-    move-wide v2, p2
+    move-object v0, p0
 
-    move-wide v4, p4
+    move-object v2, p1
 
-    invoke-interface/range {v0 .. v5}, Landroid/net/INetworkStatsService;->getNetworkTotalBytes(Landroid/net/NetworkTemplate;JJ)J
+    move-wide v3, p2
 
-    move-result-wide v0
+    move-wide v5, p4
 
-    invoke-static/range {p0 .. p5}, Lcom/android/server/net/NetworkPolicyManagerService$Injector;->adjustMobileDataUsage(Lcom/android/server/net/NetworkPolicyManagerService;Landroid/net/NetworkTemplate;JJ)J
+    invoke-static/range {v0 .. v6}, Lcom/android/server/net/NetworkPolicyManagerService$Injector;->getNetworkTotalBytes(Lcom/android/server/net/NetworkPolicyManagerService;Landroid/net/INetworkStatsService;Landroid/net/NetworkTemplate;JJ)J
     :try_end_0
     .catch Ljava/lang/RuntimeException; {:try_start_0 .. :try_end_0} :catch_0
     .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_1
 
-    move-result-wide v2
-
-    add-long/2addr v0, v2
+    move-result-wide v0
 
     :goto_0
     return-wide v0
diff --git a/services.jar.out/smali/com/android/server/pm/Installer.smali b/services.jar.out/smali/com/android/server/pm/Installer.smali
index 5221c24..4f4a92d 100644
--- a/services.jar.out/smali/com/android/server/pm/Installer.smali
+++ b/services.jar.out/smali/com/android/server/pm/Installer.smali
@@ -1,4 +1,4 @@
-.class Lcom/android/server/pm/Installer;
+.class public Lcom/android/server/pm/Installer;
 .super Ljava/lang/Object;
 .source "Installer.java"
 
@@ -22,7 +22,7 @@
 
 
 # direct methods
-.method constructor <init>()V
+.method public constructor <init>()V
     .locals 1
 
     .prologue
@@ -586,6 +586,21 @@
 
 
 # virtual methods
+.method public callExecute(Ljava/lang/String;)I
+    .locals 1
+    .parameter "cmd"
+    .annotation build Landroid/annotation/MiuiHook;
+        value = .enum Landroid/annotation/MiuiHook$MiuiHookType;->NEW_METHOD:Landroid/annotation/MiuiHook$MiuiHookType;
+    .end annotation
+
+    .prologue
+    invoke-direct {p0, p1}, Lcom/android/server/pm/Installer;->execute(Ljava/lang/String;)I
+
+    move-result v0
+
+    return v0
+.end method
+
 .method public clearUserData(Ljava/lang/String;I)I
     .locals 3
     .parameter "name"
diff --git a/services.jar.out/smali/com/android/server/pm/PackageManagerService.smali b/services.jar.out/smali/com/android/server/pm/PackageManagerService.smali
index 36d6662..985cb85 100644
--- a/services.jar.out/smali/com/android/server/pm/PackageManagerService.smali
+++ b/services.jar.out/smali/com/android/server/pm/PackageManagerService.smali
@@ -953,14 +953,24 @@
     invoke-static {v2, v3}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
     :goto_1
-    new-instance v2, Lcom/android/server/pm/Installer;
+    new-instance v2, Lcom/android/server/pm/MiuiInstaller;
 
-    invoke-direct {v2}, Lcom/android/server/pm/Installer;-><init>()V
+    invoke-direct {v2}, Lcom/android/server/pm/MiuiInstaller;-><init>()V
 
     move-object/from16 v0, p0
 
     iput-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mInstaller:Lcom/android/server/pm/Installer;
 
+    move-object/from16 v0, p0
+
+    iget-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
+
+    move-object/from16 v0, p0
+
+    iget-object v3, v0, Lcom/android/server/pm/PackageManagerService;->mInstaller:Lcom/android/server/pm/Installer;
+
+    invoke-static {v2, v3}, Lcom/android/server/pm/PackageManagerService$Injector;->startMiuiShellService(Landroid/content/Context;Lcom/android/server/pm/Installer;)V
+
     const-string v2, "window"
 
     move-object/from16 v0, p1
@@ -2359,6 +2369,12 @@
 
     move-object/from16 v0, p0
 
+    iget-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+
+    invoke-static {v2}, Lcom/android/server/pm/ExtraPackageManagerServices;->performPreinstallApp(Lcom/android/server/pm/Settings;)V
+
+    move-object/from16 v0, p0
+
     iget-boolean v2, v0, Lcom/android/server/pm/PackageManagerService;->mOnlyCore:Z
 
     if-nez v2, :cond_18
@@ -2934,6 +2950,8 @@
 
     iput-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mRequiredVerifierPackage:Ljava/lang/String;
 
+    invoke-static {}, Lcom/android/server/pm/ExtraPackageManagerServices;->postScanPackages()V
+
     monitor-exit v43
     :try_end_9
     .catchall {:try_start_9 .. :try_end_9} :catchall_0
@@ -3790,7 +3808,21 @@
     goto :goto_0
 
     :cond_3
-    iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mResolveInfo:Landroid/content/pm/ResolveInfo;
+    iget-object v5, p0, Lcom/android/server/pm/PackageManagerService;->mResolveInfo:Landroid/content/pm/ResolveInfo;
+
+    move-object v0, p0
+
+    move-object v1, p1
+
+    move-object v2, p2
+
+    move v3, p3
+
+    move/from16 v4, p5
+
+    invoke-static/range {v0 .. v5}, Lcom/android/server/pm/PackageManagerService$Injector;->checkMiuiHomeIntent(Lcom/android/server/pm/PackageManagerService;Landroid/content/Intent;Ljava/lang/String;IILandroid/content/pm/ResolveInfo;)Landroid/content/pm/ResolveInfo;
+
+    move-result-object v0
 
     goto :goto_0
 
@@ -5007,6 +5039,46 @@
     goto :goto_0
 .end method
 
+.method private dealFlags(Landroid/content/pm/PackageParser$Package;Lcom/android/server/pm/PackageSetting;)V
+    .locals 4
+    .parameter "pkg"
+    .parameter "pkgSetting"
+    .annotation build Landroid/annotation/MiuiHook;
+        value = .enum Landroid/annotation/MiuiHook$MiuiHookType;->NEW_METHOD:Landroid/annotation/MiuiHook$MiuiHookType;
+    .end annotation
+
+    .prologue
+    iget-object v0, p1, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+
+    iget v1, v0, Landroid/content/pm/ApplicationInfo;->flags:I
+
+    iget v2, p2, Lcom/android/server/pm/PackageSetting;->pkgFlags:I
+
+    const/high16 v3, -0x8000
+
+    and-int/2addr v2, v3
+
+    or-int/2addr v1, v2
+
+    iput v1, v0, Landroid/content/pm/ApplicationInfo;->flags:I
+
+    iget-object v0, p1, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+
+    iget v1, v0, Landroid/content/pm/ApplicationInfo;->flags:I
+
+    iget v2, p2, Lcom/android/server/pm/PackageSetting;->pkgFlags:I
+
+    const/high16 v3, 0x4000
+
+    and-int/2addr v2, v3
+
+    or-int/2addr v1, v2
+
+    iput v1, v0, Landroid/content/pm/ApplicationInfo;->flags:I
+
+    return-void
+.end method
+
 .method private deleteApplicationCacheFilesLI(Ljava/lang/String;I)Z
     .locals 7
     .parameter "packageName"
@@ -9722,6 +9794,14 @@
 
     invoke-direct/range {v1 .. v6}, Lcom/android/server/pm/PackageManagerService;->installNewPackageLI(Landroid/content/pm/PackageParser$Package;IILjava/lang/String;Lcom/android/server/pm/PackageManagerService$PackageInstalledInfo;)V
 
+    iget-object v1, v2, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+
+    move-object/from16 v0, p0
+
+    iget-object v6, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+
+    invoke-static {v1, v6}, Lcom/android/server/pm/ExtraPackageManagerServices;->postProcessNewInstall(Landroid/content/pm/ApplicationInfo;Lcom/android/server/pm/Settings;)V
+
     goto/16 :goto_6
 .end method
 
@@ -13656,7 +13736,7 @@
 
     iget-object v3, v0, Lcom/android/server/pm/PackageManagerService;->mResolveActivity:Landroid/content/pm/ActivityInfo;
 
-    const v10, 0x60d0020
+    const v10, 0x60d003e
 
     iput v10, v3, Landroid/content/pm/ActivityInfo;->theme:I
 
@@ -14671,6 +14751,14 @@
 
     iput v4, v3, Landroid/content/pm/ApplicationInfo;->flags:I
 
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, p1
+
+    move-object/from16 v2, v41
+
+    invoke-direct {v0, v1, v2}, Lcom/android/server/pm/PackageManagerService;->dealFlags(Landroid/content/pm/PackageParser$Package;Lcom/android/server/pm/PackageSetting;)V
+
     move-object/from16 v0, v41
 
     iget-object v3, v0, Lcom/android/server/pm/PackageSetting;->origPackage:Lcom/android/server/pm/PackageSettingBase;
@@ -31960,6 +32048,10 @@
     .local v5, permFile:Ljava/io/File;
     invoke-direct {p0, v5}, Lcom/android/server/pm/PackageManagerService;->readPermissionsFromXml(Ljava/io/File;)V
 
+    iget-object v6, p0, Lcom/android/server/pm/PackageManagerService;->mAvailableFeatures:Ljava/util/HashMap;
+
+    invoke-static {v6}, Lcom/android/server/pm/PackageManagerService$Injector;->addAvailableFeatures(Ljava/util/HashMap;)V
+
     goto/16 :goto_0
 .end method
 
diff --git a/services.jar.out/smali/com/android/server/pm/ShutdownThread.smali b/services.jar.out/smali/com/android/server/pm/ShutdownThread.smali
index a17668b..377224f 100644
--- a/services.jar.out/smali/com/android/server/pm/ShutdownThread.smali
+++ b/services.jar.out/smali/com/android/server/pm/ShutdownThread.smali
@@ -155,7 +155,7 @@
     invoke-direct {v1, p0}, Landroid/app/ProgressDialog;-><init>(Landroid/content/Context;)V
 
     .local v1, pd:Landroid/app/ProgressDialog;
-    const v2, 0x60c0191
+    const v2, 0x60c0026
 
     invoke-virtual {p0, v2}, Landroid/content/Context;->getText(I)Ljava/lang/CharSequence;
 
@@ -163,7 +163,7 @@
 
     invoke-virtual {v1, v2}, Landroid/app/ProgressDialog;->setTitle(Ljava/lang/CharSequence;)V
 
-    const v2, 0x60c01aa
+    const v2, 0x60c002c
 
     invoke-virtual {p0, v2}, Landroid/content/Context;->getText(I)Ljava/lang/CharSequence;
 
diff --git a/services.jar.out/smali/com/android/server/pm/UserManager.smali b/services.jar.out/smali/com/android/server/pm/UserManager.smali
index 9ec3e07..b04adb9 100644
--- a/services.jar.out/smali/com/android/server/pm/UserManager.smali
+++ b/services.jar.out/smali/com/android/server/pm/UserManager.smali
@@ -1689,7 +1689,17 @@
 
     monitor-enter v1
 
+    if-nez p1, :cond_0
+
+    const/4 v0, 0x1
+
     :try_start_0
+    monitor-exit v1
+
+    :goto_0
+    return v0
+
+    :cond_0
     iget-object v0, p0, Lcom/android/server/pm/UserManager;->mUserIds:[I
 
     invoke-static {v0, p1}, Lcom/android/internal/util/ArrayUtils;->contains([II)Z
@@ -1698,7 +1708,7 @@
 
     monitor-exit v1
 
-    return v0
+    goto :goto_0
 
     :catchall_0
     move-exception v0
diff --git a/services.jar.out/smali/com/android/server/wm/WindowManagerService.smali b/services.jar.out/smali/com/android/server/wm/WindowManagerService.smali
index 6a8013c..783f429 100644
--- a/services.jar.out/smali/com/android/server/wm/WindowManagerService.smali
+++ b/services.jar.out/smali/com/android/server/wm/WindowManagerService.smali
@@ -15411,6 +15411,10 @@
     :cond_2
     iput-boolean v5, p0, Lcom/android/server/wm/WindowManagerService;->mSafeMode:Z
 
+    const/4 v6, 0x0
+
+    iput-boolean v6, p0, Lcom/android/server/wm/WindowManagerService;->mSafeMode:Z
+
     :try_start_0
     const-string v5, "persist.sys.safemode"
 
-- 
1.7.9.5

